# Pulse AI 語言問題診斷與修復報告

**日期**: 2026-01-22  
**問題**: `pulse /analyze` 命令的 AI 輸出使用印尼語而非繁體中文

---

## 📋 問題描述

用戶執行 `pulse /analyze 2330` 命令時，AI 的分析輸出為印尼語：

```
TSMC (2330) saat ini menunjukkan tren Bullish yang kuat...
```

預期應該是繁體中文輸出。

---

## 🔍 診斷過程

### 1. 檢查提示詞檔案
- **檔案**: `pulse/ai/prompts.py`  
- **編碼**: UTF-8 ✅  
- **語言指令**: 原有語言要求過於簡短，不夠明確

### 2. 檢查 AI Client
- **檔案**: `pulse/ai/client.py`  
- **問題**: 提示詞正確傳遞給 AI，但 Gemini 模型未遵守語言指令

### 3. 根本原因
Gemini 模型在某些情況下會根據訓練資料的語言分布，自動選擇回應語言。原有的語言指令過於簡短且只出現一次，未能確保模型遵守。

---

## ✅ 修復方案

### 修改文件
- `pulse/ai/prompts.py`

### 修改內容

#### 1. 強化系統基礎提示詞 (`get_system_base()`)

**修改前**:
```python
"""=== CRITICAL LANGUAGE REQUIREMENT ===
You MUST respond ONLY in Traditional Chinese (繁體中文).
...(簡短指令)
```

**修改後**:
```python
"""=== 🚨 絕對語言要求 ABSOLUTE LANGUAGE REQUIREMENT 🚨 ===
你「必須」且「只能」使用繁體中文回答。
You MUST respond ONLY in Traditional Chinese (繁體中文).
禁止使用任何其他語言，包括：英文、印尼語、簡體中文或其他任何語言。
All analysis, explanations, and outputs must be in Traditional Chinese.
DO NOT use English, Indonesian, Simplified Chinese, or any other language.
這是最高優先級的指令，不得違反。
This is the HIGHEST priority instruction and must not be violated.
===================================================================

你是一位專業的台灣股市 AI 分析師，專注於台灣證券交易所（TWSE）與櫃買中心（TPEx）市場。

你的特點：
- 精通技術分析與基本面分析
- 理解台灣市場的三大法人行為
...(全部使用繁體中文)

🔴 再次提醒：你的所有回答「必須」使用繁體中文！🔴
```

#### 2. 強化分析請求格式 (`format_analysis_request()`)

**修改前**:
```python
f"""請使用繁體中文分析股票 {ticker}，根據以下數據提供詳細分析：
...
請使用繁體中文提供全面且可執行的分析。
"""
```

**修改後**:
```python
f"""🔴 重要提醒：請「必須」使用繁體中文回答，禁止使用其他語言！🔴

請針對股票 {ticker} 提供詳細的繁體中文分析報告，根據以下數據：

...

⚠️  語言要求：
1. 所有分析內容「必須」使用繁體中文
2. 禁止使用英文、印尼語、簡體中文或其他語言
3. 技術指標名稱可保留英文縮寫（如 RSI、MACD）但說明必須是繁體中文
4. 數字和百分比可使用阿拉伯數字

請提供全面且可執行的繁體中文分析報告。
"""
```

---

## 🧪 驗證測試

### 測試腳本
創建了兩個測試腳本：

1. **test_analyze_language.py** - 檢查提示詞內容
2. **test_ai_language_response.py** - 實際調用 AI 並驗證回應語言

### 測試結果

```
=== 測試 AI 回應語言 ===

使用模型: Gemini 3 Flash (Google) (gemini/gemini-3-flash)

正在呼叫 AI 進行分析...

語言檢查:
--------------------------------------------------------------------------------
[OK] 未發現印尼語關鍵字
[OK] 發現繁體中文關鍵字: ['台積電', '股票', '分析', '技術', '指標', '建議', '趨勢', '支撐', '壓力']
--------------------------------------------------------------------------------

[SUCCESS] 測試通過：AI 正確使用繁體中文回答
```

✅ **驗證成功** - AI 現在正確使用繁體中文回答

---

## 📊 修復效果

### 修改前
```
TSMC (2330) saat ini menunjukkan tren Bullish yang kuat, ditutup pada harga NT$ 1.760,00 (+1,15%)...
(印尼語輸出)
```

### 修改後
```
台積電 (2330) 目前呈現強勁的多頭趨勢，收盤價為 NT$ 1,760.00 (+1.15%)...
(繁體中文輸出)
```

---

## 🎯 關鍵改進點

1. **多層語言指令**: 在系統提示詞的開頭、中間和結尾都強調語言要求
2. **雙語強調**: 同時使用繁體中文和英文說明，確保模型理解
3. **明確禁止**: 列出禁止使用的語言（印尼語、簡體中文等）
4. **視覺強調**: 使用 emoji 和特殊符號（🚨、🔴、⚠️）增加指令的視覺重要性
5. **重複提醒**: 在提示詞的多個位置重複語言要求

---

## ✔️ 結論

問題已成功修復。通過強化提示詞中的語言指令，確保 Gemini 模型始終使用繁體中文回答。測試驗證通過，用戶現在可以獲得正確的繁體中文分析報告。

---

## 📝 後續建議

1. 如果未來發現其他語言問題，可以進一步調整提示詞優先級
2. 考慮在 `.env` 中添加語言設定選項（但目前繁體中文是硬編碼的）
3. 定期測試不同 AI 模型的語言遵守情況

---

**修復者**: Antigravity AI Assistant  
**測試狀態**: ✅ 通過  
**部署狀態**: ✅ 已部署
