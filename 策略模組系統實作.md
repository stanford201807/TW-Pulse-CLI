# 策略模組系統實作完成 - 導覽

## 實作摘要

成功實作完整的可擴充策略模組系統，包含基礎架構、首個策略「進階農夫播種術」、CLI命令和回測引擎。

## 已實作的檔案

### 階段一：基礎架構 ✅

#### `pulse/core/strategies/base.py`
核心類別與資料模型：
- `BaseStrategy` - 策略基礎抽象類別
- `StrategySignal` - 交易訊號資料結構
- `StrategyState` - 策略執行狀態管理
- `SignalAction` - 交易動作枚舉（買進/賣出/持有）

#### `pulse/core/strategies/registry.py`
策略註冊管理系統：
- `StrategyRegistry` - 管理所有可用策略
- 自動註冊機制
- 策略查詢與列表功能

### 階段二：進階農夫播種術策略 ✅

#### `pulse/core/strategies/farmer_planting.py`
完整的農夫播種術交易策略實作：

**核心規則**：
1. ✅ **站上年線啟動** - 價格從年線（MA200）下方站上年線時，自動買進第 1 份（主要進場訊號）
2. ✅ **基準價機制** - 追蹤上次成交價
3. ✅ **加碼規則** - 收盤價 ≥ 基準價 × 1.03，買進 1 份
4. ✅ **減碼規則** - 收盤價 ≤ 基準價 × 0.97，賣出 1 份
5. ✅ **資金控管** - 最多持有 10 份（透過 `position_count` 精確追蹤）
6. ✅ **移動停利** - 從波段最高點回落 20%，全數出場
7. ✅ **防禦機制** - 跌破 MA200 × 0.96，全數清倉
8. ✅ **抄底機制** - RSI <30 後回升，買進第 1 份（輔助進場訊號，空頭反彈用）
9. ✅ **零股買進支持** - 固定金額模式（`amount_per_position`），當股價過高時自動改用固定金額計算股數

**可配置參數**：
- `max_positions`: 最大持倉份數（預設 10）
- `shares_per_position`: 每份股數（預設 1000，設為 0 時啟用固定金額模式）
- `amount_per_position`: 每份金額（預設 100000，僅在 `shares_per_position=0` 時生效）
- `add_threshold`: 加碼門檻（預設 1.03，代表漲幅 3%）
- `reduce_threshold`: 減碼門檻（預設 0.97，代表跌幅 3%）
- `trailing_stop`: 移動停利（預設 0.20，代表回落 20%）
- `ma200_stop`: MA200 防禦（預設 0.96，代表跌破年線 4%）
- `rsi_oversold`: RSI 超賣門檻（預設 30）

### 階段三：回測引擎 ✅

#### `pulse/core/backtest/engine.py`
回測引擎核心：
- `BacktestEngine` - 主回測引擎類別
- 歷史數據載入（預設 5 年）
- 逐日 K 線模擬
- 技術指標整合（RSI, MA200）
- 交易訊號生成與執行

#### `pulse/core/backtest/position.py`
持倉管理模組：
- `PositionManager` - 持倉狀態追蹤
- `Trade` - 交易記錄資料結構
- 買賣執行邏輯
- 權益曲線計算

#### `pulse/core/backtest/report.py`
回測報告生成：
- `BacktestReport` - 報告資料結構
- 績效指標計算：
  - 總報酬率 / 年化報酬率
  - 最大回撤（Maximum Drawdown）
  - 夏普比率（Sharpe Ratio）
  - 勝率統計
- 報告格式化輸出

#### `pulse/reports/trade_report.py`
動態資金交易報表生成：
- `TradeReportGenerator` - 交易報表生成器
- 核心功能：
  - 資金份數精確追蹤（`position_count`）
  - 波段最高價追蹤（持倉期間追蹤，清倉後重置）
  - 動態資金變化計算
  - 視覺寬度對齊（中文字算 2 格）
  - 交易備註提取（RSI抄底、農夫加碼、站上年線等）

### CLI 命令整合 ✅

#### `pulse/cli/commands/strategy.py`
策略 CLI 命令處理器：
- `handle_strategy_command` - 主命令處理
- `show_strategy_menu` - 策略選單
- `show_strategy_details` - 策略詳情
- `show_strategy_status` - 策略狀態
- `run_strategy_backtest` - 執行回測

#### `pulse/cli/commands/registry.py`
已註冊策略命令：
- `/strategy` - 主命令
- 別名：`/strategies`, `/策略`

## 可用命令

### 1. 查看策略選單
```bash
/strategy
```
**輸出**：
```
=== 交易策略選單 ===

1. 進階農夫播種術
   基準價加減碼策略，適合趨勢股票的長期持有
   指令：/strategy farmer
```

### 2. 查看策略詳情
```bash
/strategy farmer
# 或
/strategy 1
```
**輸出**：策略配置參數、規則說明

### 3. 查看特定股票狀態
```bash
/strategy farmer 2330
```
**輸出**：當前持倉、基準價、加減碼門檻等

### 4. 執行回測
```bash
/strategy farmer 2330 backtest
```
**輸出**：
- 回測期間（預設 5 年）
- 績效指標（總報酬率、年化報酬率、最大回撤等）
- 交易明細（前 10 筆）
- 勝率統計

## 回測報告範例

### 最新回測結果（2330 台積電）

**回測期間**: 2021-01-26 至 2026-01-25（1825 天 / 5 年）  
**初始資金**: NT$ 1,000,000

**績效指標**：
- **總報酬率**: +99.33%
- **年化報酬率**: +14.80%
- **最大回撤**: 21.53%
- **夏普比率**: 0.96
- **總交易次數**: 89 次

**最終資產**: NT$ 1,993,330  
**總損益**: NT$ +993,330

### 動態資金交易報表（節錄）

| 日期       | 動作 |    成交價 |  持倉最高 |   漲跌% | 資金份數 |   收付金額 | 備註         |
| ---------- | ---- | --------- | --------- | ------- | -------- | ---------- | ------------ |
| 2021-05-14 | 買進 |    508.67 |    508.67 |       - |   1.0/10 |    -99,700 | RSI抄底      |
| 2021-05-21 | 買進 |    523.31 |    523.31 |   +2.9% |   2.0/10 |    -99,952 | 農夫加碼     |
| 2023-01-10 | 買進 |    460.52 |    460.52 |  +27.1% |   1.0/10 |    -99,012 | 站上年線     |
| 2024-04-11 | 買進 |    788.33 |    788.33 |   +2.0% |  10.0/10 |    -12,613 | 農夫加碼     |
| 2024-08-05 | 賣出 |    831.39 |         - |   +8.3% |   0.0/10 | +1,282,002 | 移動停利     |

> [!NOTE]
> **關鍵特性**：
> - 資金份數精確追蹤（1.0/10, 2.0/10 等整數顯示）
> - 持倉最高價在持倉期間追蹤，清倉後顯示為 `-`
> - 零股買進支持（如第 116 筆，股價 788 元時僅買 16 股）
> - 站上年線機制成功捕捉趨勢啟動點

## 測試步驟

### 必須執行
> [!IMPORTANT]
> 需要重新啟動 pulse 應用程式以載入新模組

1. **停止當前 pulse**
   ```
   Ctrl+C
   ```

2. **重新啟動**
   ```powershell
   cd d:\GitHub\TW-Pulse-CLI
   pulse
   ```

3. **測試命令**
   ```
   /strategy                     # 查看選單
   /strategy farmerplanting      # 查看策略詳情（正確鍵值）
   /strategy farmerplanting 2330 backtest  # 執行回測
   ```

## 測試總結

**測試日期**: 2026-01-25  
**測試環境**: Windows PowerShell + Python 3.14  
**測試狀態**: ✅ **全部通過（5/5）**

### 最新修復與驗證（2026-01-25）

**已修復的關鍵問題**：

1. **資金份數計算邏輯** ✅
   - 問題：原使用「持倉市值 / 每份金額」計算，導致份數不準確
   - 解決：新增 `position_count` 變數追蹤實際交易次數
   - 驗證：買進 +1 份、減碼 -1 份、清倉歸零，顯示為整數（1.0/10, 2.0/10 等）

2. **減碼股數計算** ✅
   - 問題：減碼使用固定股數，與加碼邏輯不一致
   - 解決：改用動態計算（`_calculate_buy_quantity()`）
   - 驗證：減碼股數與加碼一致，支援零股模式

3. **持倉最高價追蹤** ✅
   - 問題：清倉後仍顯示舊的最高價
   - 解決：僅在持倉期間追蹤，清倉後重置為 0
   - 驗證：清倉交易顯示 `-`，重新開倉後重新追蹤

4. **最大份數限制** ✅
   - 問題：檢查邏輯錯誤（檢查股數而非份數），導致限制失效
   - 解決：新增 `position_count` 追蹤，檢查份數是否達到 10 份
   - 驗證：最多加碼到 10.0/10，不會超過

5. **站上年線啟動機制** ✅
   - 新增：從年線下方突破時自動買進第 1 份
   - 驗證：2023-01-10 成功觸發，解決 2022-2025 期間無交易問題

6. **零股買進支持** ✅
   - 新增：固定金額模式（`amount_per_position`）
   - 驗證：股價 788 元時成功買進 16 股（約 12,613 元）

**回測驗證結果**：
- 測試標的：2330 台積電
- 回測期間：2021-01-26 至 2026-01-25（5 年）
- 總報酬率：+99.33%
- 年化報酬率：+14.80%
- 總交易次數：89 次
- ✅ 所有計算邏輯正確
- ✅ 報表格式對齊無誤
- ✅ 資金份數追蹤精確

### 已建立的測試檔案

專案包含專門的測試腳本，位於 `tests/test_cli/` 目錄：

1. **功能完整性測試**: [test_strategy_command.py](file:///d:/GitHub/TW-Pulse-CLI/tests/test_cli/test_strategy_command.py)
   - 測試策略註冊機制
   - 測試策略列表顯示
   - 測試策略鍵值解析
   - 測試策略詳情查詢
   - 測試農夫策略專項功能

2. **診斷輸出測試**: [test_strategy_diagnostic.py](file:///d:/GitHub/TW-Pulse-CLI/tests/test_cli/test_strategy_diagnostic.py)
   - 模擬 `/strategy` 命令執行
   - 模擬 `/strategy farmerplanting` 命令執行
   - 驗證輸出格式正確性

3. **測試結果文件**: [STRATEGY_TEST_RESULTS.md](file:///d:/GitHub/TW-Pulse-CLI/tests/test_cli/STRATEGY_TEST_RESULTS.md)
   - 完整的測試結果記錄
   - 已知問題說明
   - 後續行動項目

### 執行測試

```powershell
# 執行功能完整性測試
cd d:\GitHub\TW-Pulse-CLI
.venv\Scripts\python tests\test_cli\test_strategy_command.py

# 執行診斷測試
.venv\Scripts\python tests\test_cli\test_strategy_diagnostic.py
```

### 測試結果

| 測試項目 | 狀態 | 說明 |
|---------|------|------|
| 策略註冊機制 | ✅ PASS | `farmerplanting` 策略成功註冊 |
| 策略列表顯示 | ✅ PASS | 正確顯示「進階農夫播種術」 |
| 策略鍵值解析 | ✅ PASS | 成功解析並實例化策略 |
| 策略詳情查詢 | ✅ PASS | 所有配置參數正確顯示 |
| 農夫策略測試 | ✅ PASS | 核心規則驗證通過 |
| 命令處理邏輯 | ✅ PASS | 輸出格式符合預期 |

### 已驗證的功能

**策略註冊系統**:
- ✅ 策略類別正確註冊到全域註冊表
- ✅ 策略鍵值: `farmerplanting`
- ✅ 策略名稱: 進階農夫播種術
- ✅ 策略描述正確顯示

**策略配置參數**:
- ✅ `max_positions`: 10（最大持倉份數）
- ✅ `shares_per_position`: 1000（每份股數）
- ✅ `add_threshold`: 1.03（加碼門檻，漲幅 3%）
- ✅ `reduce_threshold`: 0.97（減碼門檻，跌幅 3%）
- ✅ `trailing_stop`: 0.2（移動停利，回落 20%）
- ✅ `ma200_stop`: 0.96（MA200 防禦倍數）
- ✅ `rsi_oversold`: 30（RSI 超賣門檻）

**命令處理器**:
- ✅ `handle_strategy_command()` 邏輯正確
- ✅ `show_strategy_menu()` 格式化輸出正常
- ✅ `show_strategy_details()` 參數顯示完整
- ✅ 錯誤處理機制健全

### 正確使用方式

> [!IMPORTANT]
> 策略鍵值為 **`farmerplanting`**（完整名稱），而非簡寫 `farmer`

**命令格式**：

```bash
# 顯示策略選單
/strategy

# 顯示策略詳情（使用完整鍵值）
/strategy farmerplanting

# 或使用策略編號
/strategy 1

# 查看特定股票的策略狀態
/strategy farmerplanting 2330

# 執行回測
/strategy farmerplanting 2330 backtest
```

**命令別名**：
- `/strategies`
- `/策略`

### 已修復問題

> [!NOTE]
> **TUI 輸出問題（已修復）**
> 
> **問題描述**: 在 pulse TUI 應用程式中輸入 `/strategy` 後，無法看到即時輸出。
> 
> **解決方案** (2026-01-25):
> 1. **返回值修復**: 將所有命令處理函數改為返回字符串，並修復 `registry.py` 中的 `_cmd_strategy()` 返回值
> 2. **Markdown 格式轉換**: 將所有 Rich 標記（`[bold]`、`[cyan]` 等）轉換為標準 Markdown 格式
> 3. **測試狀態**: ✅ 所有自動化測試通過，手動測試確認輸出正常
> 
> **相關文檔**: [TUI 顯示修復導覽](file:///C:/Users/User/.gemini/antigravity/brain/d8a2d667-b715-4d8a-a5cd-a855c6fcfb04/walkthrough.md)

### Workflow 文件

可使用 `/strategy` workflow 作為操作指南：

```bash
/strategy  # 在 Antigravity IDE 中輸入此命令
```

或直接查看: [.agent/workflows/strategy.md](file:///d:/GitHub/TW-Pulse-CLI/.agent/workflows/strategy.md)

## 系統架構

```
pulse/
├── core/
│   ├── strategies/           【策略模組】
│   │   ├── __init__.py      - 模組初始化
│   │   ├── base.py          - 基礎類別
│   │   ├── registry.py      - 註冊系統
│   │   └── farmer_planting.py - 農夫播種術
│   │
│   └── backtest/            【回測引擎】
│       ├── __init__.py      - 模組初始化
│       ├── engine.py        - 回測引擎
│       ├── position.py      - 持倉管理
│       └── report.py        - 報告生成
│
├── reports/                 【交易報表】
│   ├── __init__.py         - 模組初始化
│   └── trade_report.py     - 動態資金交易報表生成
│
└── cli/
    └── commands/
        └── strategy.py      - CLI 命令處理
```

## 擴充指南

### 新增策略

1. 在 `pulse/core/strategies/` 建立新策略檔案
2. 繼承 `BaseStrategy` 並實作：
   - `initialize()` - 初始化
   - `on_bar()` - K 線處理
   - `get_config_schema()` - 配置結構
3. 在 `__init__.py` 註冊策略

範例：
```python
from pulse.core.strategies.base import BaseStrategy

class MyStrategy(BaseStrategy):
    def __init__(self):
        super().__init__(
            name="我的策略",
            description="策略描述"
        )
    
    async def initialize(self, ticker, initial_cash, config):
        # 初始化邏輯
        pass
    
    async def on_bar(self, bar, indicators):
        # 策略邏輯
        return signal  # or None
    
    def get_config_schema(self):
        return {...}
```

## 已知限制

1. **回測假設**：
   - 使用開盤價執行交易（實際可能有滑價）
   - 未考慮手續費和交易稅
   - 假設流動性充足

2. **數據限制**：
   - 依賴 yfinance 數據品質
   - 技術指標需要足夠的歷史數據

3. **績效指標**：
   - 簡化版勝率計算（基於平均成本）
   - 未實作配對交易分析

## 後續改進方向

1. **進階功能**：
   - 參數優化（Grid Search / 遺傳算法）
   - 多策略組合與權重配置
   - 即時監控與通知（Telegram / Line）
   - 策略熱重載（無需重啟）

2. **報告增強**：
   - 權益曲線圖表（Matplotlib / Plotly）
   - 每月 / 每年收益分析
   - 勝率熱力圖（按月份 / 市況）
   - CSV/JSON 匯出功能
   - 與買入持有策略對比

3. **回測優化**：
   - Walk-forward 驗證（避免過度優化）
   - 手續費與交易稅計算（台股 0.1425% + 0.3%）
   - 滑價模擬（市價單 vs 限價單）
   - 多時間框架回測（日線 + 週線）
   - 資金曲線回撤分析

4. **已完成** ✅：
   - ~~動態資金交易報表~~ ✅
   - ~~零股買進支持~~ ✅
   - ~~站上年線啟動機制~~ ✅
   - ~~資金份數精確追蹤~~ ✅
