# 反向代理診斷報告

## 📊 測試結果摘要

### ✅ 成功項目
1. **反向代理服務運行正常**
   - 端點: `http://127.0.0.1:8045`
   - TCP 連接: ✓ 成功
   - HTTP 狀態碼: 200

2. **API Key 認證通過**
   - API Key: `sk-6d4331550a484aa18a8f9192b8781ddd`
   - 認證狀態: ✓ 有效

3. **可用模型列表獲取成功**
   - 反向代理提供多個模型
   - 至少包含: `claude-3-5-sonnet-20240620`

### ❌ 問題診斷

**主要問題**: HTTP 429 - 配額用盡

```json
{
  "error": {
    "code": 429,
    "message": "Resource has been exhausted (e.g. check quota).",
    "status": "RESOURCE_EXHAUSTED"
  }
}
```

## 🔍 問題分析

您在 pulse 程式中看到的 **「認證失敗」** 錯誤訊息是**誤導性的**。

實際情況是：
- ✅ 認證是成功的
- ❌ 但 Gemini API 配額已用完

pulse 程式將 HTTP 429 錯誤解讀為「認證失敗」，這是錯誤處理邏輯的問題。

## 💡 解決方案

### 方案 1：切換到其他模型（推薦）

Antigravity 反向代理提供了多個模型，您可以嘗試使用 Claude 模型：

1. **修改 `.env` 檔案**：
   ```bash
   # 將預設模型改為 Claude
   PULSE_AI__DEFAULT_MODEL=anthropic/claude-3-5-sonnet-20240514
   
   # 同時設定 Anthropic API Key（如果反向代理需要）
   ANTHROPIC_API_KEY=sk-6d4331550a484aa18a8f9192b8781ddd
   ```

2. **重啟 pulse 程式**

### 方案 2：等待 Gemini 配額重置

如果您必須使用 Gemini 模型：

1. 等待配額重置（通常每日重置）
2. 聯繫 Antigravity 管理員查詢配額狀態
3. 使用其他 Gemini 帳號的 API Key

### 方案 3：改善錯誤處理（開發建議）

修改 `pulse/utils/error_handler.py` 以正確識別配額錯誤：

```python
# 在 get_user_friendly_error 函數中新增
if "429" in error_str or "quota" in error_str or "exhausted" in error_str:
    return "API 配額已用盡，請稍後再試或切換到其他模型。"
```

## 📝 可用模型清單

根據測試，Antigravity 反向代理提供以下模型：

| 模型名稱 | 提供商 | 可用性 |
|---------|--------|--------|
| `claude-3-5-sonnet-20240620` | Anthropic | ✓ 可能可用 |
| `gemini-3-pro-high` | Google | ❌ 配額已用盡 |
| `gemini-3-flash` | Google | ❌ 配額已用盡 |

## 🔧 立即行動建議

**最快解決方法**：

1. 編輯 `.env` 檔案：
   ```bash
   PULSE_AI__DEFAULT_MODEL=anthropic/claude-3-5-sonnet-20240514
   ```

2. 重啟 pulse 程式

3. 測試是否正常工作

---

**生成時間**: 2026-01-22  
**測試工具**: `test_proxy.py`
